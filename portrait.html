<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="styles.css">
	<title>PMD Portrait Repository</title>
	
	<script
		src="https://code.jquery.com/jquery-3.3.1.js"
		integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
		crossorigin="anonymous">
	</script>
	<script>
		$(function(){
			$("#header").load("header.html"); 
			$("#footer").load("footer.html"); 
		});
		
		function findGetParameter(parameterName) {
			let result = null, tmp = [];
			location.search.substr(1).split("&").forEach(function (item) {
				tmp = item.split("=");
				if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
			});
			return result;
		}
		
		function checkURLExists(url){ //gets what faces are avilable in a form
		
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status != 200) {
					return false;
				}else{
					return true;
				}
			};
		}
		
		async function populateTable(id){
		
			let tracker = await fetch('tracker.json').then(response => response.json());
			let container = document.getElementById("container");
			
			//get the entry
			let entry = tracker[id];
			if (!entry) entry = tracker["0000"];

			forms = subgroupUnfolding(entry); //look at how many forms it has
			
			for (i in forms) {
				
				let title = document.createElement("h2");
				title.innerHTML = forms[i].name
				title.setAttribute("class", "port-title");
				container.appendChild(title);
				
				let table = makeTable(forms[i].path)
				table.setAttribute("class", "port-table");
				let row = table.insertRow(8);
				let cell = row.insertCell(0);
				cell.innerHTML = "Credit: " +forms[i].portrait_credit;
				cell.setAttribute("class", "port-expresion");
				cell.setAttribute("colspan", 5);
				container.appendChild(table);
				
				/*let donwload = document.createElement("div");
				donwload.innerHTML = "<p>Download!</p>"
				donwload.setAttribute("onclick", "createFilledImage(\""+forms[i].path+"\")");
				donwload.setAttribute("class", "Button");
				container.appendChild(donwload);*/
			}
				
		}
		
		function subgroupUnfolding(entry,path = "/"){ //I dont even know, dont read this, you dont deserve the migraine
		
			let subgroups = [];
			
			if (entry.name && entry.portrait_credit){
				let nentry = Object.assign({}, entry);
				nentry.path = path;
				delete nentry.subgroups;
				subgroups = subgroups.concat(nentry);
			}
			
			for (let i in entry.subgroups){
				ipath = path + i + "/";
				if (entry.subgroups[i].subgroups) (subgroups = subgroups.concat(subgroupUnfolding(entry.subgroups[i],ipath)));
			}
			
			return subgroups;
		}
		
		function imgMissing(img,index){
			
			img.src = "empty.png";
			missingExpresions[index] = true;
		}
		
		function makeTable(path){
		
			//theres probably a better way to do this using arrays with less copy paste, but meh
				
			let table = document.createElement("table");
			table.setAttribute("class", "port-table");
			let row
			let cell
			
			row = table.insertRow(0);
			
			cell = row.insertCell(0);
			cell.innerHTML = "<img onerror=\"imgMissing(this,0)\" src=\"portrait/"+id+path+"Normal.png\"></img>";
			cell = row.insertCell(1);
			cell.innerHTML = "<img onerror=\"imgMissing(this,1)\" src=\"portrait/"+id+path+"Happy.png\"></img>";
			cell = row.insertCell(2);
			cell.innerHTML = "<img onerror=\"imgMissing(this,2)\" src=\"portrait/"+id+path+"Pain.png\"></img>";
			cell = row.insertCell(3);
			cell.innerHTML = "<img onerror=\"imgMissing(this,3)\" src=\"portrait/"+id+path+"Angry.png\"></img>";
			cell = row.insertCell(4);
			cell.innerHTML = "<img onerror=\"imgMissing(this,4)\" src=\"portrait/"+id+path+"Worried.png\"></img>";
			
			
			row = table.insertRow(1);
			
			cell = row.insertCell(0);
			cell.innerHTML = "Normal";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(1);
			cell.innerHTML = "Happy";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(2);
			cell.innerHTML = "Pain";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(3);
			cell.innerHTML = "Angry";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(4);
			cell.innerHTML = "Worried";
			cell.setAttribute("class", "port-expresion");
			
			row = table.insertRow(2);
			
			cell = row.insertCell(0);
			cell.innerHTML = "<img onerror=\"imgMissing(this,5)\" src=\"portrait/"+id+path+"Sad.png\"></img>";
			cell = row.insertCell(1);
			cell.innerHTML = "<img onerror=\"imgMissing(this,6)\" src=\"portrait/"+id+path+"Crying.png\"></img>";
			cell = row.insertCell(2);
			cell.innerHTML = "<img onerror=\"imgMissing(this,7)\" src=\"portrait/"+id+path+"Shouting.png\"></img>";
			cell = row.insertCell(3);
			cell.innerHTML = "<img onerror=\"imgMissing(this,8)\" src=\"portrait/"+id+path+"Teary-Eyed.png\"></img>";
			cell = row.insertCell(4);
			cell.innerHTML = "<img onerror=\"imgMissing(this,9)\" src=\"portrait/"+id+path+"Determined.png\"></img>";
			
			row = table.insertRow(3);
			
			cell = row.insertCell(0);
			cell.innerHTML = "Sad";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(1);
			cell.innerHTML = "Crying";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(2);
			cell.innerHTML = "Shouting";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(3);
			cell.innerHTML = "Teary-Eyed";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(4);
			cell.innerHTML = "Determined";
			cell.setAttribute("class", "port-expresion");
			
			row = table.insertRow(4);
			
			cell = row.insertCell(0);
			cell.innerHTML = "<img onerror=\"imgMissing(this,10)\" src=\"portrait/"+id+path+"Joyous.png\"></img>";
			cell = row.insertCell(1);
			cell.innerHTML = "<img onerror=\"imgMissing(this,11)\" src=\"portrait/"+id+path+"Inspired.png\"></img>";
			cell = row.insertCell(2);
			cell.innerHTML = "<img onerror=\"imgMissing(this,12)\" src=\"portrait/"+id+path+"Surprised.png\"></img>";
			cell = row.insertCell(3);
			cell.innerHTML = "<img onerror=\"imgMissing(this,13)\" src=\"portrait/"+id+path+"Dizzy.png\"></img>";
			cell = row.insertCell(4);
			cell.innerHTML = "<img onerror=\"imgMissing(this,14)\" src=\"portrait/"+id+path+"Special0.png\"></img>";
			
			row = table.insertRow(5);
			
			cell = row.insertCell(0);
			cell.innerHTML = "Joyous";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(1);
			cell.innerHTML = "Inspired";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(2);
			cell.innerHTML = "Surprised";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(3);
			cell.innerHTML = "Dizzy";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(4);
			cell.innerHTML = "Special0";
			cell.setAttribute("class", "port-expresion");
			
			row = table.insertRow(6);
			
			cell = row.insertCell(0);
			cell.innerHTML = "<img onerror=\"imgMissing(this,15)\" src=\"portrait/"+id+path+"Special1.png\"></img>";
			cell = row.insertCell(1);
			cell.innerHTML = "<img onerror=\"imgMissing(this,16)\" src=\"portrait/"+id+path+"Sigh.png\"></img>";
			cell = row.insertCell(2);
			cell.innerHTML = "<img onerror=\"imgMissing(this,17)\" src=\"portrait/"+id+path+"Stunned.png\"></img>";
			cell = row.insertCell(3);
			cell.innerHTML = "<img onerror=\"imgMissing(this,18)\" src=\"portrait/"+id+path+"Special2.png\"></img>";
			cell = row.insertCell(4);
			cell.innerHTML = "<img onerror=\"imgMissing(this,19)\" src=\"portrait/"+id+path+"Special3.png\"></img>";
			
			row = table.insertRow(7);
			
			cell = row.insertCell(0);
			cell.innerHTML = "Special1";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(1);
			cell.innerHTML = "Sigh";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(2);
			cell.innerHTML = "Stunned";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(3);
			cell.innerHTML = "Special2";
			cell.setAttribute("class", "port-expresion");
			cell = row.insertCell(4);
			cell.innerHTML = "Special3";
			cell.setAttribute("class", "port-expresion");
			
			return table;
		}
		
		function createFilledImage(path){
			/*
			let c=document.createElement("canvas");
			c.width = 200, c.height = 160;
			let ctx=c.getContext("2d");
			let col = 0, row = 0;
			let image;
			
			for (i = 0; i < 20; i++) {
			
				image = new Image();
				image.onload = function() {
					ctx.drawImage(image, 40 * col, 40 * row)
				};
				image.src = "portrait/"+id+path+"Normal.png";
				
				col++;
				if (col == 5){
					col = 0;
					row++;
				}
			}

			container.appendChild(c);
			var link = document.createElement('a');
			link.download = 'filename.png';
			link.href = c.toDataURL()
			link.click();*/
		}
		
		let missingExpresions = new Array(20).fill(false);
		let expresionNames = ["Normal","Happy","Pain","Angry","Worried","Sad","Crying","Shouting","Teary-Eyed","Determined","Joyous","Inspired","Surprised","Dizzy","Special0","Special1","Sigh","Stunned","Special2","Special3"]

		let id = findGetParameter("id");
		if (!(id)) id = false;
		
		populateTable(id);
	</script>
</head>
<body>
	<div id="header"></div>

	<div id="container">
	</div>

	<div id="footer"></div>
</body>
</html>